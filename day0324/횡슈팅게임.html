<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Document</title>
<style>
*{
    margin: 0px;
    padding: 0px;
}

#wrapper{
    width: 100%;
    height: 600px;
    background: url("./image/game_bg.jpg");
    position: relative;
    overflow: hidden;
}

#info{
    background: yellow;
    opacity: 0.5;
}

</style>
<script src="../js/lib.js"></script>
<script src="./Plane.js"></script>
<script src="./Bullet.js"></script>
<script src="./Enemy.js"></script>
<script>
var wrapper;
var bgX = 0; //배경 처리
var plane; //주인공 제어
var bulletAr = []; //총알 배열
var enemyAr = []; //적군 배열
var enImgAr = ["./image/e1.png", "./image/e2.png", "./image/e3.png", "./image/e4.png", "./image/e5.png"];
var info;
var cnt = 0;

function init(){
    wrapper = document.getElementById("wrapper");
    info = document.getElementById("info");
    createHero();
    
    //body태그에 키보드 이벤트 연결
    document.body.addEventListener("keydown", function(){
        pressDown();
    });

    document.body.addEventListener("keyup", function(){
        pressUp();
    });
}

function pressDown(){
    var key = event.keyCode;
    //좌우상하
    
    switch(key){
        case 39: plane.velX = 5; break;
        case 37: plane.velX = -5; break;
        case 40: plane.velY = 5; break;
        case 38: plane.velY = -5; break;
        case 32: fire(); break;
    }
}

function pressUp(){
    var key = event.keyCode;
    
    switch(key){
        case 39: plane.velX = 0; break;
        case 37: plane.velX = 0; break;
        case 40: plane.velY = 0; break;
        case 38: plane.velY = 0; break;
    }
}

function fire(){
    bullet = new Bullet(wrapper, "./image/ball.png", 25, 25, plane.x+plane.width, plane.y, 10, 0);
    bulletAr.push(bullet);
}

function createHero(){
    //container, src, width, height, x, y
    plane = new Plane(wrapper, "./image/plane.png", 70, 45, 100, 200, 0, 0);
}

function createEnemy(){
    
    var enemy = new Enemy(wrapper, enImgAr[getRandom(5)], 60, 40, 1600, (getRandom(7)+1)*50, -2, 0);
    enemyAr.push(enemy);
    //container, src, width, height, x, y, velX, velY
}

//배경이 흘러가는 효과
function bgEffect(){
    bgX--;
    wrapper.style.backgroundPosition = bgX+"px 0px";
}

function gameLoop(){
    bgEffect(); //배경 움직임
    log(); //게임의 정보
    plane.tick(); //물리량 변화
    plane.render(); //그래픽 처리
    cnt++;
    if(cnt%200 == 0){
        createEnemy();
    }
    for(var i = 0; i < bulletAr.length; i++){
        bulletAr[i].render();
        bulletAr[i].tick();
    }

    for(var i = 0; i < enemyAr.length; i++){
        enemyAr[i].render();
        enemyAr[i].tick();
    }
}

//각종 실시간 정보를 출력할 함수
function log(){
    var str = "총알갯수: "+bulletAr.length;
    str = str + ", 적군수:"+enemyAr.length;
    info.innerText = str;
}

function collisionCheck(obj1, obj2){
    //왼쪽 상단만 체크
    var x1 = parseInt(obj1.x); 
    var y1 = parseInt(obj1.y);
    var w1 = parseInt(obj1.width);
    var h1 = parseInt(obj1.height);

    var x2 = parseInt(obj2.x);
    var y2 = parseInt(obj2.y);
    var w2 = parseInt(obj2.width);
    var h2 = parseInt(obj2.height);

    
    if((x1+w1) > x2 && (y1+h1) > y2 && (x1+w1) < (x2+w2) && (y1+h1) < (y2+h2)){
        console.log("좌쪽 상단 충돌~");
        return true;
    }else if(y1 < (y2+h2) && (x1+w1) > x2 && y1 > y2 && (x1+w1) < (x2+w2)){
        console.log("좌쪽 하단 충돌~");
        return true;
    }else if(x1 < (x2+w2) && (y1+h1) > y2 && (y1+h1) < (y2+h2) && x1 > x2 ){
        console.log("우측 상단 충돌~");
        return true;
    }else if(y1 < (y2+h2) && x1 < (x2+w2) && y1 > y2 && x1 > x2){
        console.log("우측 하단 충돌~");
        return true;
    }
    return;
}

window.addEventListener("load", function(){
    init();
    setInterval("gameLoop()", 10);
});
</script>
</head>
<body>
    <div id="wrapper">
        <div id="info">게임의 대한 정보</div>
    </div>
</body>
</html>